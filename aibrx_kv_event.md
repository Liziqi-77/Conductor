┌─────────────────────────────────────────────────────────────────────────────────┐
│                           KV Event 上报与路由选择流程                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                      │
│   │   vLLM Pod 1 │    │   vLLM Pod 2 │    │   vLLM Pod N │                      │
│   │              │    │              │    │              │                      │
│   │  KV Cache    │    │  KV Cache    │    │  KV Cache    │                      │
│   │ ┌──────────┐ │    │ ┌──────────┐ │    │ ┌──────────┐ │                      │
│   │ │Block A,B │ │    │ │Block C,D │ │    │ │Block E,F │ │                      │
│   │ └──────────┘ │    │ └──────────┘ │    │ └──────────┘ │                      │
│   └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                      │
│          │                   │                   │                              │
│          │ ZMQ PUB           │ ZMQ PUB           │ ZMQ PUB                      │
│          │ (port 5557)       │ (port 5557)       │ (port 5557)                  │
│          │                   │                   │                              │
│          └───────────────────┴───────────────────┘                              │
│                              │                                                  │
│                              ▼                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐      │
│   │                     AIBrix Gateway Plugins                           │      │
│   │  ┌─────────────────────────────────────────────────────────────────┐ │      │
│   │  │                    ZMQ Client (per Pod)                         │ │      │
│   │  │  • 订阅 KV 事件 (BLOCK_STORED / BLOCK_REMOVED)                   │ │      │
│   │  │  • 解码 MsgPack 消息                                             │ │      │
│   │  │  • 断线重连 + 事件回放                                            │ │      │
│   │  └────────────────────────────┬────────────────────────────────────┘ │      │
│   │                               │                                      │      │
│   │                               ▼                                      │      │
│   │  ┌─────────────────────────────────────────────────────────────────┐ │      │
│   │  │                    KV Event Manager                             │ │      │
│   │  │  • 管理 Pod 订阅生命周期                                          │ │      │
│   │  │  • 事件分发到 Sync Indexer                                       │ │      │
│   │  └────────────────────────────┬────────────────────────────────────┘ │      │
│   │                               │                                      │      │
│   │                               ▼                                      │      │
│   │  ┌─────────────────────────────────────────────────────────────────┐ │      │
│   │  │              Sync Prefix Cache Indexer                          │ │      │
│   │  │  • 维护全局前缀缓存状态表                                         │ │      │
│   │  │  • Model/LoRA → PrefixHash → Pod 映射                           │ │      │
│   │  │  • 支持 LRU 驱逐策略                                             │ │      │
│   │  └────────────────────────────┬────────────────────────────────────┘ │      │
│   │                               │                                      │      │
│   │                               ▼                                      │      │
│   │  ┌─────────────────────────────────────────────────────────────────┐ │      │
│   │  │              Prefix Cache Router (路由算法)                      │ │      │
│   │  │  • 查询哪个 Pod 有请求的前缀缓存                                  │ │      │
│   │  │  • 选择缓存命中率最高的 Pod                                       │ │      │
│   │  │  • 负载均衡兜底策略                                               │ │      │
│   │  └─────────────────────────────────────────────────────────────────┘ │      │
│   └──────────────────────────────────────────────────────────────────────┘      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
